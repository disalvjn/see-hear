<style>
</style>
<canvas id="canvas"></canvas>
<p></p>
<a id="download" download="myImage.png" href="" onclick="download_img(this);">Download to myImage.jpg</a>
<script>

 function interpret(ctx, image) {
     image["image/renders"].forEach(item => {
         let color = item["render/color"];
         let shape = item["render/shape"];
         if (shape["shape/type"] == "polygon") {
             let points = shape["polygon/points"];
             ctx.beginPath();
             ctx.moveTo(points[0]["point/x"], points[0]["point/y"]);
             for (var i = 1; i < points.length; i++) {
                 ctx.lineTo(points[i]["point/x"], points[i]["point/y"]);
             }
             ctx.closePath();
             // ctx.stroke();
             ctx.fillStyle = color;
             ctx.fill();
         } else if (shape["shape/type"] == "circle") {
             ctx.beginPath();
             let center = shape["circle/center"];
             ctx.arc(center["point/x"], center["point/y"], shape["circle/radius"], shape["circle/start"], shape["circle/end"]);
             ctx.fillStyle = color;
             ctx.fill();
         }
     });
 }

 let canvas = document.getElementById('canvas');
 let ctx = canvas.getContext('2d');

 let ws = new WebSocket("ws://localhost:8080");
 ws.onmessage = function(event) {
    let data = JSON.parse(event.data);

    let width = data["image/width"];
    let height = data["image/height"];
    
    canvas.width = width;
    canvas.height = height;
    canvas.color = data["image/background-color"];

     // {height: , width:, pixels: [{x:, y:, color: }]}
     // color in hex
     ctx.clearRect(0, 0, width, height);
     if (data["image/background-color"]) {
         ctx.fillStyle = data["image/background-color"];
         ctx.fillRect(0, 0, width, height);
     }
     interpret(ctx, data);
 }

download_img = function(el) {
  var image = canvas.toDataURL("image/png");
  el.href = image;
};

</script>

